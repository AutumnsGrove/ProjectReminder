<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Login - Reminders</title>
    <link rel="stylesheet" href="css/main.css">
    <link rel="icon" href="favicon.ico">
    <style>
        .login-page {
            min-height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
            background: var(--color-bg-secondary);
            padding: var(--spacing-md);
        }

        .login-container {
            width: 100%;
            max-width: 400px;
            background: var(--color-bg-primary);
            border-radius: var(--radius-lg);
            box-shadow: var(--shadow-lg);
            padding: var(--spacing-xl);
        }

        .login-header {
            text-align: center;
            margin-bottom: var(--spacing-xl);
        }

        .login-title {
            font-size: var(--font-size-xxl);
            font-weight: 600;
            color: var(--color-text-primary);
            margin-bottom: var(--spacing-xs);
        }

        .login-subtitle {
            font-size: var(--font-size-base);
            color: var(--color-text-secondary);
        }

        .form-group {
            margin-bottom: var(--spacing-lg);
        }

        .form-label {
            display: block;
            font-size: var(--font-size-sm);
            font-weight: 500;
            color: var(--color-text-primary);
            margin-bottom: var(--spacing-sm);
        }

        .form-input {
            width: 100%;
            padding: var(--spacing-md);
            border: 2px solid var(--color-border);
            border-radius: var(--radius-md);
            font-size: var(--font-size-base);
            font-family: var(--font-family);
            transition: border-color var(--transition-fast);
            background: var(--color-bg-primary);
            color: var(--color-text-primary);
        }

        .form-input:focus {
            outline: none;
            border-color: var(--color-primary);
        }

        .form-input::placeholder {
            color: var(--color-text-disabled);
        }

        .code-input {
            font-size: var(--font-size-xxl);
            letter-spacing: 8px;
            text-align: center;
            font-family: monospace;
        }

        .btn-primary {
            width: 100%;
            padding: var(--spacing-md);
            background: var(--color-primary);
            color: var(--color-text-white);
            border: none;
            border-radius: var(--radius-md);
            font-size: var(--font-size-base);
            font-weight: 500;
            font-family: var(--font-family);
            cursor: pointer;
            transition: background var(--transition-fast);
        }

        .btn-primary:hover {
            background: var(--color-primary-dark);
        }

        .btn-primary:disabled {
            background: var(--color-text-disabled);
            cursor: not-allowed;
        }

        .error-message {
            color: var(--color-danger);
            font-size: var(--font-size-sm);
            margin-top: var(--spacing-sm);
        }

        .success-message {
            color: var(--color-success);
            font-size: var(--font-size-sm);
            margin-top: var(--spacing-sm);
        }

        .step-hidden {
            display: none;
        }

        .back-link {
            display: block;
            text-align: center;
            margin-top: var(--spacing-md);
            color: var(--color-text-secondary);
            font-size: var(--font-size-sm);
            cursor: pointer;
            transition: color var(--transition-fast);
        }

        .back-link:hover {
            color: var(--color-primary);
        }

        .sent-email {
            color: var(--color-text-primary);
            font-weight: 500;
        }

        .loading-spinner {
            display: inline-block;
            width: 16px;
            height: 16px;
            border: 2px solid var(--color-text-white);
            border-top-color: transparent;
            border-radius: 50%;
            animation: spin 0.8s linear infinite;
            margin-right: var(--spacing-sm);
            vertical-align: middle;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        .app-logo {
            font-size: 48px;
            margin-bottom: var(--spacing-md);
        }

        .info-text {
            font-size: var(--font-size-sm);
            color: var(--color-text-secondary);
            text-align: center;
            margin-top: var(--spacing-lg);
            padding-top: var(--spacing-lg);
            border-top: 1px solid var(--color-border);
        }
    </style>
</head>
<body>
    <div class="login-page">
        <div class="login-container">
            <div class="login-header">
                <div class="app-logo">üìã</div>
                <h1 class="login-title">Welcome Back</h1>
                <p class="login-subtitle">Sign in to your reminders</p>
            </div>

            <!-- Step 1: Email -->
            <div id="emailStep">
                <div class="form-group">
                    <label class="form-label" for="email">Email address</label>
                    <input
                        type="email"
                        id="email"
                        class="form-input"
                        placeholder="you@example.com"
                        autocomplete="email"
                        autofocus
                    >
                    <div id="emailError" class="error-message"></div>
                </div>
                <button id="sendCodeBtn" class="btn-primary">
                    Send login code
                </button>
            </div>

            <!-- Step 2: Code -->
            <div id="codeStep" class="step-hidden">
                <p class="login-subtitle" style="margin-bottom: var(--spacing-lg);">
                    We sent a 6-digit code to<br>
                    <span id="sentEmail" class="sent-email"></span>
                </p>
                <div class="form-group">
                    <label class="form-label" for="code">Enter code</label>
                    <input
                        type="text"
                        id="code"
                        class="form-input code-input"
                        placeholder="000000"
                        maxlength="6"
                        inputmode="numeric"
                        pattern="[0-9]*"
                        autocomplete="one-time-code"
                    >
                    <div id="codeError" class="error-message"></div>
                    <div id="codeSuccess" class="success-message"></div>
                </div>
                <button id="verifyCodeBtn" class="btn-primary">
                    Verify code
                </button>
                <span id="backToEmail" class="back-link">‚Üê Use different email</span>
            </div>

            <p class="info-text">
                Secure passwordless login via email
            </p>
        </div>
    </div>

    <script src="js/storage.js"></script>
    <script src="js/auth.js"></script>
    <script>
        // Check authentication status and redirect if already logged in
        // This handles both Cloudflare Access and magic code sessions
        (async function() {
            const usingCloud = await Auth.isUsingCloudAPI();
            if (!usingCloud) {
                // Not using cloud API, redirect to app
                window.location.href = 'index.html';
                return;
            }

            // Check for existing session
            if (Auth.isAuthenticated()) {
                window.location.href = 'index.html';
                return;
            }

            // Check server-side auth status (detects Cloudflare Access)
            try {
                const authStatus = await Auth.checkAuthStatus();
                if (authStatus.authenticated) {
                    // User is authenticated via CF Access or other method
                    console.log('Authenticated via:', authStatus.method);
                    window.location.href = 'index.html';
                    return;
                }
            } catch (error) {
                console.error('Auth check failed:', error);
            }

            // Not authenticated, show login form
        })();

        let currentEmail = '';

        // DOM elements
        const emailStep = document.getElementById('emailStep');
        const codeStep = document.getElementById('codeStep');
        const emailInput = document.getElementById('email');
        const codeInput = document.getElementById('code');
        const sendCodeBtn = document.getElementById('sendCodeBtn');
        const verifyCodeBtn = document.getElementById('verifyCodeBtn');
        const backToEmail = document.getElementById('backToEmail');
        const emailError = document.getElementById('emailError');
        const codeError = document.getElementById('codeError');
        const codeSuccess = document.getElementById('codeSuccess');
        const sentEmail = document.getElementById('sentEmail');

        // Send code
        sendCodeBtn.addEventListener('click', async () => {
            const email = emailInput.value.trim();

            if (!email || !email.includes('@')) {
                emailError.textContent = 'Please enter a valid email address';
                return;
            }

            emailError.textContent = '';
            sendCodeBtn.disabled = true;
            sendCodeBtn.innerHTML = '<span class="loading-spinner"></span>Sending...';

            try {
                const result = await Auth.requestCode(email);

                if (result.error === 'Too many requests') {
                    const minutes = Math.ceil((result.retryAfter || 900) / 60);
                    emailError.textContent = `Too many attempts. Please wait ${minutes} minutes.`;
                    sendCodeBtn.disabled = false;
                    sendCodeBtn.textContent = 'Send login code';
                    return;
                }

                if (!result.success && result.error) {
                    emailError.textContent = result.message;
                    sendCodeBtn.disabled = false;
                    sendCodeBtn.textContent = 'Send login code';
                    return;
                }

                // Show code step
                currentEmail = email;
                sentEmail.textContent = email;
                emailStep.classList.add('step-hidden');
                codeStep.classList.remove('step-hidden');
                codeInput.focus();

            } catch (error) {
                emailError.textContent = 'Failed to send code. Please try again.';
            }

            sendCodeBtn.disabled = false;
            sendCodeBtn.textContent = 'Send login code';
        });

        // Verify code
        verifyCodeBtn.addEventListener('click', async () => {
            const code = codeInput.value.trim();

            if (!code || code.length !== 6) {
                codeError.textContent = 'Please enter the 6-digit code';
                return;
            }

            codeError.textContent = '';
            codeSuccess.textContent = '';
            verifyCodeBtn.disabled = true;
            verifyCodeBtn.innerHTML = '<span class="loading-spinner"></span>Verifying...';

            try {
                const result = await Auth.verifyCode(currentEmail, code);

                if (!result.success) {
                    codeError.textContent = result.message;
                    verifyCodeBtn.disabled = false;
                    verifyCodeBtn.textContent = 'Verify code';
                    return;
                }

                // Success - show message then redirect
                codeSuccess.textContent = 'Success! Redirecting...';
                setTimeout(() => {
                    window.location.href = 'index.html';
                }, 500);

            } catch (error) {
                codeError.textContent = 'Verification failed. Please try again.';
                verifyCodeBtn.disabled = false;
                verifyCodeBtn.textContent = 'Verify code';
            }
        });

        // Back to email
        backToEmail.addEventListener('click', () => {
            codeStep.classList.add('step-hidden');
            emailStep.classList.remove('step-hidden');
            codeInput.value = '';
            codeError.textContent = '';
            codeSuccess.textContent = '';
            emailInput.focus();
        });

        // Enter key handlers
        emailInput.addEventListener('keypress', (e) => {
            if (e.key === 'Enter') sendCodeBtn.click();
        });

        codeInput.addEventListener('keypress', (e) => {
            if (e.key === 'Enter') verifyCodeBtn.click();
        });

        // Auto-format code input (numbers only)
        codeInput.addEventListener('input', (e) => {
            e.target.value = e.target.value.replace(/\D/g, '').slice(0, 6);
        });
    </script>
</body>
</html>
