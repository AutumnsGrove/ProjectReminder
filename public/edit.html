<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="description" content="ADHD-friendly reminders app - Create/Edit reminder">
    <title>Edit Reminder</title>
    <link rel="stylesheet" href="css/main.css">
    <link rel="stylesheet" href="css/edit.css">
    <link rel="stylesheet" href="css/location.css">
    <!-- MapBox GL JS (Phase 6: Location Features) -->
    <link href="https://api.mapbox.com/mapbox-gl-js/v3.0.1/mapbox-gl.css" rel="stylesheet">
    <script src="https://api.mapbox.com/mapbox-gl-js/v3.0.1/mapbox-gl.js"></script>
</head>
<body>
    <div class="app-container">
        <!-- Header -->
        <header class="app-header">
            <button class="btn-icon btn-back" id="backBtn" aria-label="Go back">
                <span class="icon">‚Üê</span>
            </button>
            <h1 class="page-title" id="pageTitle">New Reminder</h1>
            <!-- Sync Status Indicator (Phase 5) -->
            <div class="header-actions">
                <div class="sync-status" id="syncStatus" title="Sync status">
                    <span class="sync-indicator" id="syncIndicator"></span>
                    <span class="sync-text" id="syncText">Offline</span>
                </div>
                <button class="btn-icon" id="syncBtn" aria-label="Sync now" title="Sync now">
                    <span class="icon">‚ü≥</span>
                </button>
                <button class="btn-icon" id="deleteBtn" aria-label="Delete" title="Delete" style="display: none;">
                    <span class="icon">üóë</span>
                </button>
            </div>
        </header>

        <!-- Main Content -->
        <main class="main-content">
            <form id="reminderForm" class="reminder-form">
                <!-- Hidden ID field for editing -->
                <input type="hidden" id="reminderId" name="id">

                <!-- Reminder Text -->
                <div class="form-group">
                    <label for="reminderText" class="form-label">What do you need to do?</label>
                    <div class="voice-input-wrapper">
                        <textarea
                            id="reminderText"
                            name="text"
                            class="form-control"
                            rows="3"
                            placeholder="e.g., Call mom about Thanksgiving"
                            required
                            autofocus
                        ></textarea>

                        <button
                            type="button"
                            id="voiceRecorderBtn"
                            class="voice-recorder-btn"
                            aria-label="Record voice reminder"
                        >
                            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24">
                                <path d="M12 14c1.66 0 2.99-1.34 2.99-3L15 5c0-1.66-1.34-3-3-3S9 3.34 9 5v6c0 1.66 1.34 3 3 3zm5.3-3c0 3-2.54 5.1-5.3 5.1S6.7 14 6.7 11H5c0 3.41 2.72 6.23 6 6.72V21h2v-3.28c3.28-.48 6-3.3 6-6.72h-1.7z"/>
                            </svg>
                        </button>
                    </div>

                    <!-- Voice recording timer -->
                    <div id="voiceRecorderTimer" class="voice-recorder-timer"></div>
                </div>

                <!-- Priority -->
                <div class="form-group">
                    <label class="form-label">Priority</label>
                    <div class="priority-selector">
                        <label class="priority-option">
                            <input type="radio" name="priority" value="someday">
                            <span class="priority-badge someday">üîµ Someday</span>
                        </label>
                        <label class="priority-option">
                            <input type="radio" name="priority" value="chill" checked>
                            <span class="priority-badge chill">üü¢ Chill</span>
                        </label>
                        <label class="priority-option">
                            <input type="radio" name="priority" value="important">
                            <span class="priority-badge important">üü° Important</span>
                        </label>
                        <label class="priority-option">
                            <input type="radio" name="priority" value="urgent">
                            <span class="priority-badge urgent">üî¥ Urgent</span>
                        </label>
                        <label class="priority-option">
                            <input type="radio" name="priority" value="waiting">
                            <span class="priority-badge waiting">üü† Waiting</span>
                        </label>
                    </div>
                </div>

                <!-- Category -->
                <div class="form-group">
                    <label for="category" class="form-label">Category</label>
                    <select id="category" name="category" class="form-control">
                        <option value="">None</option>
                        <option value="Personal">Personal</option>
                        <option value="Work">Work</option>
                        <option value="Errands">Errands</option>
                        <option value="Home">Home</option>
                        <option value="Health">Health</option>
                        <option value="Calls">Calls</option>
                        <option value="Shopping">Shopping</option>
                        <option value="Projects">Projects</option>
                    </select>
                </div>

                <!-- Due Date -->
                <div class="form-group">
                    <label for="dueDate" class="form-label">Due Date</label>
                    <input
                        type="date"
                        id="dueDate"
                        name="due_date"
                        class="form-control"
                    >
                    <small class="form-hint">Leave empty for "anytime" tasks</small>
                </div>

                <!-- Due Time -->
                <div class="form-group">
                    <label for="dueTime" class="form-label">Due Time</label>
                    <input
                        type="time"
                        id="dueTime"
                        name="due_time"
                        class="form-control"
                        placeholder="Click to pick time"
                    >
                    <small class="form-hint">Optional - Click to use time picker üïê</small>
                </div>

                <!-- Time Required -->
                <div class="form-group">
                    <label for="timeRequired" class="form-label">
                        <input
                            type="checkbox"
                            id="timeRequired"
                            name="time_required"
                        >
                        Time-sensitive task
                    </label>
                    <small class="form-hint">Check if this task must be done at a specific time</small>
                </div>

                <!-- Location Picker (Phase 6) -->
                <div class="form-group">
                    <label for="locationSearch" class="form-label">Location</label>

                    <!-- Hidden fields for location data -->
                    <input type="hidden" id="locationName" name="location_name">
                    <input type="hidden" id="locationAddress" name="location_address">
                    <input type="hidden" id="locationLat" name="location_lat">
                    <input type="hidden" id="locationLng" name="location_lng">
                    <input type="hidden" id="locationRadius" name="location_radius" value="100">

                    <!-- Search input -->
                    <div class="location-search-container">
                        <input
                            type="text"
                            id="locationSearch"
                            class="form-control"
                            placeholder="Search for a place or address..."
                        >
                        <button type="button" class="btn btn-secondary btn-sm" id="useMyLocationBtn">
                            üìç Use My Location
                        </button>
                    </div>

                    <!-- Map container (initially hidden) -->
                    <div id="mapContainer" class="map-container" style="display: none;">
                        <div id="locationMap" class="location-map"></div>
                        <div class="map-controls">
                            <label for="radiusSlider" class="form-label-sm">Reminder Radius: <span id="radiusValue">100m</span></label>
                            <input
                                type="range"
                                id="radiusSlider"
                                min="10"
                                max="10000"
                                value="100"
                                step="10"
                                class="radius-slider"
                            >
                        </div>
                    </div>

                    <!-- Current location display -->
                    <div id="locationDisplay" class="location-display" style="display: none;">
                        <div class="location-info">
                            <strong id="locationDisplayName"></strong>
                            <small id="locationDisplayAddress"></small>
                        </div>
                        <button type="button" class="btn-icon btn-sm" id="clearLocationBtn" title="Clear location">
                            <span class="icon">‚úï</span>
                        </button>
                    </div>

                    <small class="form-hint">Click map or search to set reminder location</small>
                </div>

                <!-- Recurrence (Phase 7) -->
                <div class="form-group">
                    <label class="form-label">Recurrence</label>

                    <!-- Hidden field for recurrence pattern ID -->
                    <input type="hidden" id="recurrenceId" name="recurrence_id">

                    <!-- Frequency selector -->
                    <div class="recurrence-frequency">
                        <label class="recurrence-option">
                            <input type="radio" name="recurrence_frequency" value="none" checked>
                            <span class="recurrence-badge">None</span>
                        </label>
                        <label class="recurrence-option">
                            <input type="radio" name="recurrence_frequency" value="daily">
                            <span class="recurrence-badge">üìÖ Daily</span>
                        </label>
                        <label class="recurrence-option">
                            <input type="radio" name="recurrence_frequency" value="weekly">
                            <span class="recurrence-badge">üìÜ Weekly</span>
                        </label>
                        <label class="recurrence-option">
                            <input type="radio" name="recurrence_frequency" value="monthly">
                            <span class="recurrence-badge">üóìÔ∏è Monthly</span>
                        </label>
                        <label class="recurrence-option">
                            <input type="radio" name="recurrence_frequency" value="yearly">
                            <span class="recurrence-badge">üìÖ Yearly</span>
                        </label>
                    </div>

                    <!-- Recurrence details (initially hidden) -->
                    <div id="recurrenceDetails" class="recurrence-details" style="display: none;">
                        <!-- Interval -->
                        <div class="recurrence-interval">
                            <label for="recurrenceInterval" class="form-label-sm">Repeat every</label>
                            <div class="interval-input-group">
                                <input
                                    type="number"
                                    id="recurrenceInterval"
                                    min="1"
                                    max="365"
                                    value="1"
                                    class="form-control-sm"
                                >
                                <span id="intervalUnit" class="interval-unit">day(s)</span>
                            </div>
                        </div>

                        <!-- Days of week (for weekly) -->
                        <div id="daysOfWeekContainer" class="days-of-week-container" style="display: none;">
                            <label class="form-label-sm">On these days:</label>
                            <div class="days-of-week">
                                <label class="day-checkbox">
                                    <input type="checkbox" value="0">
                                    <span>Mon</span>
                                </label>
                                <label class="day-checkbox">
                                    <input type="checkbox" value="1">
                                    <span>Tue</span>
                                </label>
                                <label class="day-checkbox">
                                    <input type="checkbox" value="2">
                                    <span>Wed</span>
                                </label>
                                <label class="day-checkbox">
                                    <input type="checkbox" value="3">
                                    <span>Thu</span>
                                </label>
                                <label class="day-checkbox">
                                    <input type="checkbox" value="4">
                                    <span>Fri</span>
                                </label>
                                <label class="day-checkbox">
                                    <input type="checkbox" value="5">
                                    <span>Sat</span>
                                </label>
                                <label class="day-checkbox">
                                    <input type="checkbox" value="6">
                                    <span>Sun</span>
                                </label>
                            </div>
                        </div>

                        <!-- Day of month (for monthly) -->
                        <div id="dayOfMonthContainer" class="day-of-month-container" style="display: none;">
                            <label for="dayOfMonth" class="form-label-sm">On day:</label>
                            <input
                                type="number"
                                id="dayOfMonth"
                                min="1"
                                max="31"
                                value="1"
                                class="form-control-sm"
                            >
                        </div>

                        <!-- End conditions -->
                        <div class="recurrence-end">
                            <label class="form-label-sm">End condition:</label>
                            <div class="end-condition-options">
                                <label class="end-option">
                                    <input type="radio" name="recurrence_end" value="never" checked>
                                    <span>Never</span>
                                </label>
                                <label class="end-option">
                                    <input type="radio" name="recurrence_end" value="date">
                                    <span>On date</span>
                                </label>
                                <label class="end-option">
                                    <input type="radio" name="recurrence_end" value="count">
                                    <span>After</span>
                                </label>
                            </div>

                            <!-- End date input -->
                            <div id="endDateContainer" class="end-date-container" style="display: none;">
                                <input
                                    type="date"
                                    id="recurrenceEndDate"
                                    class="form-control-sm"
                                >
                            </div>

                            <!-- End count input -->
                            <div id="endCountContainer" class="end-count-container" style="display: none;">
                                <input
                                    type="number"
                                    id="recurrenceEndCount"
                                    min="1"
                                    max="999"
                                    value="10"
                                    class="form-control-sm"
                                >
                                <span>occurrences</span>
                            </div>
                        </div>

                        <!-- Preview -->
                        <div class="recurrence-preview">
                            <label class="form-label-sm">Preview (next 3):</label>
                            <div id="recurrencePreview" class="preview-dates">
                                <small class="form-hint">Configure recurrence pattern to see preview</small>
                            </div>
                        </div>
                    </div>

                    <small class="form-hint">Set up recurring reminders for regular tasks</small>
                </div>

                <!-- Form Actions -->
                <div class="form-actions">
                    <button type="button" class="btn btn-secondary" id="cancelBtn">Cancel</button>
                    <button type="submit" class="btn btn-primary" id="saveBtn">Save</button>
                </div>
            </form>
        </main>
    </div>

    <!-- Toast Notification Container -->
    <div id="toast-container" class="toast-container"></div>

    <!-- Scripts -->
    <script src="js/storage.js?v=2"></script>
    <script src="js/errors.js?v=2"></script>
    <script src="js/api.js?v=2"></script>
    <script src="js/sync.js?v=2"></script>
    <script src="js/animations.js?v=2"></script>
    <script src="js/mapbox.js?v=2"></script>
    <script src="js/location-picker.js?v=2"></script>
    <script src="js/recurrence.js?v=2"></script>
    <script src="js/voice-recorder.js?v=2"></script>
    <script src="js/app.js?v=2"></script>
    <script>
        // Initialize Edit view
        document.addEventListener('DOMContentLoaded', async () => {
            if (typeof App !== 'undefined' && App.init && App.initEditView) {
                await App.init(); // Wait for API config to load first!
                App.initEditView();
            }

            // Initialize location picker (Phase 6)
            if (typeof LocationPicker !== 'undefined') {
                await LocationPicker.init();
            }

            // Initialize recurrence UI (Phase 7)
            if (typeof RecurrenceUI !== 'undefined') {
                RecurrenceUI.init();
            }

            // Initialize sync manager (Phase 5)
            if (typeof SyncManager !== 'undefined') {
                SyncManager.init();

                // Update sync status UI
                SyncManager.onSyncStatusChange((status) => {
                    const indicator = document.getElementById('syncIndicator');
                    const text = document.getElementById('syncText');
                    const syncBtn = document.getElementById('syncBtn');

                    if (indicator && text) {
                        // Update indicator color and text
                        indicator.className = `sync-indicator sync-${status}`;

                        switch(status) {
                            case 'offline':
                                text.textContent = 'Offline';
                                break;
                            case 'online':
                                text.textContent = 'Online';
                                break;
                            case 'syncing':
                                text.textContent = 'Syncing...';
                                if (syncBtn) syncBtn.disabled = true;
                                break;
                            case 'synced':
                                const lastSync = SyncManager.lastSync();
                                if (lastSync) {
                                    const date = new Date(lastSync);
                                    const now = new Date();
                                    const diff = Math.floor((now - date) / 1000 / 60); // minutes
                                    if (diff < 1) {
                                        text.textContent = 'Just synced';
                                    } else if (diff < 60) {
                                        text.textContent = `Synced ${diff}m ago`;
                                    } else {
                                        text.textContent = 'Synced';
                                    }
                                } else {
                                    text.textContent = 'Synced';
                                }
                                if (syncBtn) syncBtn.disabled = false;
                                break;
                            case 'error':
                                text.textContent = 'Sync error';
                                if (syncBtn) syncBtn.disabled = false;
                                break;
                        }
                    }
                });

                // Manual sync button handler
                const syncBtn = document.getElementById('syncBtn');
                if (syncBtn) {
                    syncBtn.addEventListener('click', async () => {
                        await SyncManager.sync();
                    });
                }
            }
        });

        // Back button handler
        document.getElementById('backBtn')?.addEventListener('click', () => {
            window.history.back();
        });

        // Cancel button handler
        document.getElementById('cancelBtn')?.addEventListener('click', () => {
            window.history.back();
        });

        // Form submit handler
        document.getElementById('reminderForm')?.addEventListener('submit', (e) => {
            e.preventDefault();
            if (typeof App !== 'undefined' && App.handleReminderSubmit) {
                App.handleReminderSubmit(e);
            }
        });

        // Delete button handler
        document.getElementById('deleteBtn')?.addEventListener('click', () => {
            if (typeof App !== 'undefined' && App.handleReminderDelete) {
                App.handleReminderDelete();
            }
        });
    </script>
</body>
</html>